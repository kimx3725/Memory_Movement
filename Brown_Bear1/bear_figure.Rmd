---
title: "bear_figure"
author: "Dennis Kim"
date: "2023-04-19"
output: html_document
---

# Objective 

Create a figure of the bear TSLV esimates from two different models 

## Document Preamble 
```{r preamble, include = FALSE}
# load libraries
library(knitr)
library(here)
library(amt)
library(ggplot2)
library(tidyverse)
library(broom)
library(cowplot)
options(width = 150)

# set knitr options 
opts_chunk$set(fig.width = 6, fig.height = 5, comment = NA)
```

# Data preparation

Read in the ssf data 
```{r}
# read the ssf bear data
ssfdat <- read.csv(here::here("data", "ssfdat.bear.final.tslv.csv"))

# create log_sl and cos_ta columns
ssfdat <- ssfdat %>% mutate(log_sl_ = log(sl_),
                            cos_ta_ = cos(ta_),
                            t1_ = as.POSIXct(t1_, format = "%Y-%m-%d %H:%M:%S"),
                            t2_ = as.POSIXct(t2_, format = "%Y-%m-%d %H:%M:%S"))
ssfdat
```

store coefficents and confidence intervals (CIs) in the restructured data for the visualization. 
```{r visualization}
# name the model fit to the df 
tslv.model <- ssfdat %>% filter(t1_ > "2006-05-24 04:18:00.00") %>% amt::fit_issf(case_ ~ berries + tslv + I(tslv^2) + log_sl_+ cos_ta_ + strata(step_id_), model = TRUE)

tslv.model

# get the coefficient values
coef.data <- tslv.model$model$coefficients %>% tidy() %>% 'colnames<-'(c("beta", "coefficient"))
coef.data

ci.data <- tslv.model$model %>% confint() %>% data.frame() %>% 'colnames<-'(c("CI2.5", "CI97.5")) %>% mutate(beta = coef.data$beta)
ci.data

model.fit.data <- left_join(coef.data, ci.data)
model.fit.data
```

Create a coefficient plot 
```{r coef plot}
ggplot(model.fit.data, aes(coefficient, beta, color = factor(beta)))+
  geom_vline(xintercept = 0, lty=2, lwd=1, colour="grey50")+
  geom_point(size=3, pch=20, position=position_dodge(width=0.5))+
  geom_linerange(aes(xmax = CI2.5, xmin = CI97.5))+
  theme_bw()+
  xlab("Effect size")+
  theme(legend.position = "none", axis.title.y = element_blank())+
  ggtitle("TSLV model: SSF Parameter estimates")
```

## RSS for movements - SSF model

prepare dataframe for calculating RSS. 
```{r nonlinear RSS}
ssfdat %>% summary()

# Make a new data.frame for s1 
s1 <- data.frame(
    tslv = seq(from = 0, to = 365, length.out = 100),
    berries = 1.5,
    sl_ = 580,
    log_sl_ = log(580),
    cos_ta_ = 1
)

# data.frame for s2 
s2 <- data.frame(
    tslv =  120,
    berries = 1.5,
    sl_ = 1050,
    log_sl_ = log(580),
    cos_ta_ = 1
)

# calculate log-RSS with large-sample confidence intervals 
lr_m1 <- log_rss(tslv.model, s1, s2)

# check the header of the data.frame
head(lr_m1)

# plot usinig ggplot2
p1 <- ggplot(lr_m1$df, aes(x = tslv_x1, y = exp(log_rss))) +
  geom_line(size = 1) +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "gray30") +
  xlab("Time Since Last Visit (Days)") +
  ylab("log-RSS vs Mean TSLV") +
  theme_bw()+
  ggtitle("(a) iSSF with a quadratic term of TSLV")

p1

# save the plot 
ggsave("Bear_figure_conference1.png", p1, width = 4, height = 3)
#ggsave("RSS.TSLV_plot.png", RSS.TSLV, width = 14, height = 9)
```

## Thompson et al. 2022 model 
```{r thompson}
p2 <- ggplot(data.frame(x = c(0, 365)), aes(x = x), size = 5)+
  stat_function(fun = dnorm, args = list(352.2, 14.5), size = 1)+
  xlab("Time Since Last Visit (Days)")+
  ylab("Relative Attractiveness")+
  theme_bw()+
  ggtitle("(b) Thompson et al. 2022")

p2
```
combine the plots together 
```{r together}
cmb_plot <-
  plot_grid(
    p1,
    p2,
    nrow = 2
  )

cmb_plot

# save the plot 
ggsave("Bear_figure_conference.png", cmb_plot, width = 4, height = 4)
ggsave("Bear_figure.png", cmb_plot, width = 15, height = 7)
```



## Footer
```{r footer}
sessionInfo()
```
