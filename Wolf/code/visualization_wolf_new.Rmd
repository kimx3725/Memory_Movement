---
title: "visualization_wolf"
author: "Dennis Kim"
date: "2023-07-04"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
#options(width=165,digits.secs = 3)
#opts_chunk$set(fig.width=7,fig.height=8, error=TRUE,cache = FALSE)
```

# Load packages 
```{r packages, message =FALSE, warning = FALSE}
# data calling & wrangling 
library(here)
library(readr)
library(tidyr)
library(purrr)
library(dplyr)
library(forcats)
library(tibble)
library(stringr)
library(data.table)
library(tidyr)

# model fit 
library(amt)

# visualization
library(ggplot2)
library(jtools)
library(ggstance)
library(broom.mixed)
library(gridExtra)
library(cowplot)
library(RColorBrewer)
```

# Load data 

Call wolf tslv data from different burn-in approaches 
```{r call summer 5A tracking data}
# call the data
wolf1.1 <- read_rds(here("data","wolf.burnin.1.1.rds")) # burn in method 1.1
wolf1.2 <- read_rds(here("data", "wolf.burnin.1.2.rds")) # burn in method 1.2

wolf2.1 <- read_rds(here("data","wolf.burnin.2.1.rds")) # burn in method 2.1
wolf2.2 <- read_rds(here("data","wolf.burnin.2.2.rds")) # burn in method 2.2

wolf3.1 <- read_rds(here("data","wolf.burnin.3.1.rds")) # burn in method 3.1
wolf3.2 <- read_rds(here("data","wolf.burnin.3.2.rds")) # burn in method 3.2

# create the log_TSLV
wolf1.1$log_TSLV <- log(wolf1.1$TSLV)
wolf1.2$log_TSLV <- log(wolf1.2$TSLV)

wolf2.1$log_TSLV <- log(wolf2.1$TSLV)
wolf2.2$log_TSLV <- log(wolf2.2$TSLV)

wolf3.1$log_TSLV <- log(wolf3.1$TSLV)
wolf3.2$log_TSLV <- log(wolf3.2$TSLV)

# create the factor for case
wolf1.1$cases <- as.factor(ifelse(wolf1.1$case_ == TRUE, "used", "available"))
wolf1.2$cases <- as.factor(ifelse(wolf1.2$case_ == TRUE, "used", "available"))

wolf2.1$cases <- as.factor(ifelse(wolf2.1$case_ == TRUE, "used", "available"))
wolf2.2$cases <- as.factor(ifelse(wolf2.2$case_ == TRUE, "used", "available"))

wolf3.1$cases <- as.factor(ifelse(wolf3.1$case_ == TRUE, "used", "available"))
wolf3.2$cases <- as.factor(ifelse(wolf3.2$case_ == TRUE, "used", "available"))

summary(wolf1.1$TSLV)
summary(wolf1.2$TSLV)

summary(wolf2.1$TSLV)
summary(wolf2.2$TSLV)

summary(wolf3.1$TSLV)
summary(wolf3.2$TSLV)
```

look at the distribution of dist_edge and TSLV filter the data futher
```{r distribution}
# there is relatively fewer distance to edge happening above 2000 so we restrict our data to max 2000
hist(wolf1.1$dist_edge) 
hist(wolf1.2$dist_edge)

hist(wolf2.1$dist_edge)
hist(wolf2.2$dist_edge)

hist(wolf3.2$dist_edge)
hist(wolf3.2$dist_edge)

# TSLV histogram
hist(wolf1.1$TSLV)
hist(wolf1.2$TSLV)

hist(wolf2.1$TSLV)
hist(wolf2.2$TSLV)

hist(wolf3.1$TSLV)
hist(wolf3.2$TSLV)


# filter the data only within the dist_edge 2000
wolf.final1.1 <- wolf1.1 %>% dplyr::filter(dist_edge < 2000)
wolf.final1.2 <- wolf1.2 %>% dplyr::filter(dist_edge < 2000)

wolf.final2.1 <- wolf2.1 %>% dplyr::filter(dist_edge < 2000)
wolf.final2.2 <- wolf2.2 %>% dplyr::filter(dist_edge < 2000)

wolf.final3.1 <- wolf3.1 %>% dplyr::filter(dist_edge < 2000)
wolf.final3.2 <- wolf3.2 %>% dplyr::filter(dist_edge < 2000)
```


## Fit the model 

model fits with the interaction term of dist_edge and log(TSLV) - 1 month burn-in period
```{r ssf 1 month}
# 1 month burn-in period 

## method 1
tslv.model1.1 <- wolf.final1.1 %>% dplyr::select(-tslv) %>% filter(t1_ >"2004-12-03 22:01:00.0") %>% amt::fit_issf(case_ ~ dist_edge + log_TSLV +dist_edge:log_TSLV + log_sl_+ cos_ta_ + strata(step_id_), model = TRUE)

## method 2
tslv.model2.1 <- wolf.final2.1  %>% dplyr::select(-tslv) %>% filter(t1_ >"2004-12-03 22:01:00.0") %>% amt::fit_issf(case_ ~ dist_edge + log_TSLV +dist_edge:log_TSLV + log_sl_+ cos_ta_ + strata(step_id_), model = TRUE)

## method 3 
tslv.model3.1 <- wolf.final3.1  %>% dplyr::select(-tslv) %>% filter(t1_ >"2004-12-03 22:01:00.0") %>% amt::fit_issf(case_ ~ dist_edge + log_TSLV +dist_edge:log_TSLV + log_sl_+ cos_ta_ + strata(step_id_), model = TRUE)

summary(tslv.model1.1$model)
summary(tslv.model2.1$model)
summary(tslv.model3.1$model)
```

2 month burn-in period
```{r ssf 1 month}
# 2 month burn-in period 

## method 1
tslv.model1.2 <- wolf.final1.2 %>% dplyr::select(-tslv) %>% filter(t1_ >"2005-01-03 22:01:00.0") %>% amt::fit_issf(case_ ~ dist_edge + log_TSLV +dist_edge:log_TSLV + log_sl_+ cos_ta_ + strata(step_id_), model = TRUE)

## method 2
tslv.model2.2 <- wolf.final2.2 %>% dplyr::select(-tslv) %>% filter(t1_ >"2005-01-03 22:01:00.0") %>% amt::fit_issf(case_ ~ dist_edge + log_TSLV +dist_edge:log_TSLV + log_sl_+ cos_ta_ + strata(step_id_), model = TRUE)

## method 3 
tslv.model3.2 <- wolf.final3.2 %>% dplyr::select(-tslv) %>% filter(t1_ >"2005-01-03 22:01:00.0") %>% amt::fit_issf(case_ ~ dist_edge + log_TSLV +dist_edge:log_TSLV + log_sl_+ cos_ta_ + strata(step_id_), model = TRUE)

summary(tslv.model1.2$model)
summary(tslv.model2.2$model)
summary(tslv.model3.2$model)
```

# Coefficient plots

store coefficents and confidence intervals (CIs) in the restructured data for the visualization. 

1 month
```{r coefficients}
# 1 month period 

# get the coefficient values
coef.data1.1 <-
  tslv.model1.1$model$coefficients %>% tidy() %>% 'colnames<-'(c("beta", "coefficient"))
coef.data2.1 <-
  tslv.model2.1$model$coefficients %>% tidy() %>% 'colnames<-'(c("beta", "coefficient"))
coef.data3.1 <-
  tslv.model3.1$model$coefficients %>% tidy() %>% 'colnames<-'(c("beta", "coefficient"))

# get the confidence intervals
ci.data1.1 <-
  tslv.model1.1$model %>% confint() %>% data.frame() %>% 'colnames<-'(c("CI2.5", "CI97.5")) %>% mutate(beta = coef.data1.1$beta)
ci.data2.1 <-
  tslv.model2.1$model %>% confint() %>% data.frame() %>% 'colnames<-'(c("CI2.5", "CI97.5")) %>% mutate(beta = coef.data2.1$beta)
ci.data3.1 <-
  tslv.model3.1$model %>% confint() %>% data.frame() %>% 'colnames<-'(c("CI2.5", "CI97.5")) %>% mutate(beta = coef.data3.1$beta)

model.fit.data1.1 <- left_join(coef.data1.1, ci.data1.1)
model.fit.data2.1 <- left_join(coef.data2.1, ci.data2.1)
model.fit.data3.1 <- left_join(coef.data3.1, ci.data3.1)

model.fit.data1.1
model.fit.data2.1
model.fit.data3.1
```

Create a coefficient plot 
```{r coef plot 1 month}
# 1 month period

ggplot(model.fit.data1.1, aes(coefficient, beta, color = factor(beta)))+
  geom_vline(xintercept = 0, lty=2, lwd=1, colour="grey50")+
  geom_point(size=3, pch=20, position=position_dodge(width=0.5))+
  geom_linerange(aes(xmax = CI2.5, xmin = CI97.5))+
  theme_bw()+
  xlab("Effect size")+
  theme(legend.position = "none", axis.title.y = element_blank())+
  ggtitle("Method 1")

ggplot(model.fit.data2.1, aes(coefficient, beta, color = factor(beta)))+
  geom_vline(xintercept = 0, lty=2, lwd=1, colour="grey50")+
  geom_point(size=3, pch=20, position=position_dodge(width=0.5))+
  geom_linerange(aes(xmax = CI2.5, xmin = CI97.5))+
  theme_bw()+
  xlab("Effect size")+
  theme(legend.position = "none", axis.title.y = element_blank())+
  ggtitle("Method 2")

ggplot(model.fit.data3.1, aes(coefficient, beta, color = factor(beta)))+
  geom_vline(xintercept = 0, lty=2, lwd=1, colour="grey50")+
  geom_point(size=3, pch=20, position=position_dodge(width=0.5))+
  geom_linerange(aes(xmax = CI2.5, xmin = CI97.5))+
  theme_bw()+
  xlab("Effect size")+
  theme(legend.position = "none", axis.title.y = element_blank())+
  ggtitle("Method 3")
```

2 month
```{r coefficients}
# 2 month period 

# get the coefficient values
coef.data1.2 <-
  tslv.model1.2$model$coefficients %>% tidy() %>% 'colnames<-'(c("beta", "coefficient"))
coef.data2.2 <-
  tslv.model2.2$model$coefficients %>% tidy() %>% 'colnames<-'(c("beta", "coefficient"))
coef.data3.2 <-
  tslv.model3.2$model$coefficients %>% tidy() %>% 'colnames<-'(c("beta", "coefficient"))

# get the confidence intervals
ci.data1.2 <-
  tslv.model1.2$model %>% confint() %>% data.frame() %>% 'colnames<-'(c("CI2.5", "CI97.5")) %>% mutate(beta = coef.data1.2$beta)
ci.data2.2 <-
  tslv.model2.2$model %>% confint() %>% data.frame() %>% 'colnames<-'(c("CI2.5", "CI97.5")) %>% mutate(beta = coef.data2.2$beta)
ci.data3.2 <-
  tslv.model3.2$model %>% confint() %>% data.frame() %>% 'colnames<-'(c("CI2.5", "CI97.5")) %>% mutate(beta = coef.data3.2$beta)

model.fit.data1.2 <- left_join(coef.data1.2, ci.data1.2)
model.fit.data2.2 <- left_join(coef.data2.2, ci.data2.2)
model.fit.data3.2 <- left_join(coef.data3.2, ci.data3.2)

model.fit.data1.2
model.fit.data2.2
model.fit.data3.2
```

Create a coefficient plot 
```{r coef plot 1 month}
# 1 month period

ggplot(model.fit.data1.2, aes(coefficient, beta, color = factor(beta)))+
  geom_vline(xintercept = 0, lty=2, lwd=1, colour="grey50")+
  geom_point(size=3, pch=20, position=position_dodge(width=0.5))+
  geom_linerange(aes(xmax = CI2.5, xmin = CI97.5))+
  theme_bw()+
  xlab("Effect size")+
  theme(legend.position = "none", axis.title.y = element_blank())+
  ggtitle("Method 1")

ggplot(model.fit.data2.2, aes(coefficient, beta, color = factor(beta)))+
  geom_vline(xintercept = 0, lty=2, lwd=1, colour="grey50")+
  geom_point(size=3, pch=20, position=position_dodge(width=0.5))+
  geom_linerange(aes(xmax = CI2.5, xmin = CI97.5))+
  theme_bw()+
  xlab("Effect size")+
  theme(legend.position = "none", axis.title.y = element_blank())+
  ggtitle("Method 2")

ggplot(model.fit.data3.2, aes(coefficient, beta, color = factor(beta)))+
  geom_vline(xintercept = 0, lty=2, lwd=1, colour="grey50")+
  geom_point(size=3, pch=20, position=position_dodge(width=0.5))+
  geom_linerange(aes(xmax = CI2.5, xmin = CI97.5))+
  theme_bw()+
  xlab("Effect size")+
  theme(legend.position = "none", axis.title.y = element_blank())+
  ggtitle("Method 3")
```

# used and available distribution 
```{r distribution 1 month}
# model 1 

## 1 month burn in 

# method 1
plot1_m1_30 <- ggplot(wolf1.1, aes(x = dist_edge, y= exp(log_TSLV)))+
  geom_density_2d_filled(contour_var = "ndensity", bins = 5)+
  scale_fill_brewer(palette = "Spectral")+
  facet_wrap(~cases)+
  xlab("Distance to the edge (m)") +
  ylab("TSLV (day)")+
  ggtitle("(a) method 1")+
  theme_classic()

plot1_m2_30 <- ggplot(wolf2.1, aes(x = dist_edge, y= exp(log_TSLV)))+
  geom_density_2d_filled(contour_var = "ndensity", bins = 5)+
  scale_fill_brewer(palette = "Spectral")+
  facet_wrap(~cases)+
  xlab("Distance to the edge (m)") +
  ylab("TSLV (day)")+
  ggtitle("(a) method 2")+
  theme_classic()

plot1_m3_30 <- ggplot(wolf3.1, aes(x = dist_edge, y= exp(log_TSLV)))+
  geom_density_2d_filled(contour_var = "ndensity", bins = 5)+
  scale_fill_brewer(palette = "Spectral")+
  facet_wrap(~cases)+
  xlab("Distance to the edge (m)") +
  ylab("TSLV (day)")+
  ggtitle("(a) method 3")+
  theme_classic()

plot1_m1_30
plot1_m2_30
plot1_m3_30
```

```{r distribution 2 months}
## 2 month burn in 
plot1_m1_60 <- ggplot(wolf1.2, aes(x = dist_edge, y= exp(log_TSLV)))+
  geom_density_2d_filled(contour_var = "ndensity", bins = 5)+
  scale_fill_brewer(palette = "Spectral")+
  facet_wrap(~cases)+
  xlab("Distance to the edge (m)") +
  ylab("TSLV (day)")+
  ggtitle("(a) method 1")+
  theme_classic()

plot1_m2_60 <- ggplot(wolf2.2, aes(x = dist_edge, y= exp(log_TSLV)))+
  geom_density_2d_filled(contour_var = "ndensity", bins = 5)+
  scale_fill_brewer(palette = "Spectral")+
  facet_wrap(~cases)+
  xlab("Distance to the edge (m)") +
  ylab("TSLV (day)")+
  ggtitle("(a) method 2")+
  theme_classic()

plot1_m3_60 <- ggplot(wolf3.2, aes(x = dist_edge, y= exp(log_TSLV)))+
  geom_density_2d_filled(contour_var = "ndensity", bins = 5)+
  scale_fill_brewer(palette = "Spectral")+
  facet_wrap(~cases)+
  xlab("Distance to the edge (m)") +
  ylab("TSLV (day)")+
  ggtitle("(c) method 3")+
  theme_classic()

plot1_m1_60
plot1_m2_60
plot1_m3_60
```

# RSS for movements

## 3 month burn in period
logRSS as a function of both dist_edge and log(TSLV) compared to a location with both set to their mean
```{r RSS dist 3 month}
# creating vectors
dist_range <- seq(from = 0, to = 2000, length.out = 100)
tslv_range_30 <- seq(from = 0, to = 30, length.out = 100)

# 30 days

# expand grid - 30 days
exp_grid_tslv_30_dist <- expand.grid(dist_range, tslv_range_30)
colnames(exp_grid_tslv_30_dist) <- c("dist_edge", "log_TSLV")
exp_grid_tslv_30_dist

# include all the necessary data.frame 
exp_grid_tslv_30_dist$sl_ <- 1000
exp_grid_tslv_30_dist$log_sl_ <- log(1000)
exp_grid_tslv_30_dist$cos_ta_ <- 1

exp_grid_tslv_30_dist

# data.frame for s2 
s2_30days <- data.frame(
    dist_edge = 952,
    log_TSLV = log(15),
    sl_ = 1000,
    log_sl_ = log(1000),
    cos_ta_ = 1
)

# calculate log-RSS with large-sample confidence intervals 

## method 1
lr_m1_30 <- amt::log_rss(tslv.model1.1, exp_grid_tslv_30_dist, s2_30days)
lr_m1_30 <- lr_m1_30$df

## method 2
lr_m2_30 <- amt::log_rss(tslv.model2.1, exp_grid_tslv_30_dist, s2_30days)
lr_m2_30 <- lr_m2_30$df
lr_m2_30

## method 3
lr_m3_30 <- amt::log_rss(tslv.model3.1, exp_grid_tslv_30_dist, s2_30days)
lr_m3_30 <- lr_m3_30$df
lr_m3_30
```

plot - 30 days
```{r linear RSS 30}
plot2_m1_30 <- ggplot(lr_m1_30, aes(x = dist_edge_x1, y = log_TSLV_x1, z = log_rss))+
  stat_contour(geom = "polygon", aes(fill = ..level..), bins = 5)+
  geom_tile(aes(fill = log_rss))+
  scale_fill_distiller(palette = "Spectral", direction = 1)+
  labs(fill = "log_RSS")+
  xlab("Distance to the edge (m)")+
  ylab("TSLV (day)")+
  #ggtitle("(b) method 1: log-RSS vs Mean dist_edge and TSLV")+
  theme_classic()

plot2_m2_30 <- ggplot(lr_m2_30, aes(x = dist_edge_x1, y = log_TSLV_x1, z = log_rss))+
  stat_contour(geom = "polygon", aes(fill = ..level..), bins = 5)+
  geom_tile(aes(fill = log_rss))+
  scale_fill_distiller(palette = "Spectral", direction = 1)+
  labs(fill = "log_RSS")+
  xlab("Distance to the edge (m)")+
  ylab("TSLV (day)")+
 #ggtitle("(b) method 2.1: log-RSS vs Mean dist_edge and TSLV")+
  theme_classic()

plot2_m3_30 <- ggplot(lr_m3_30, aes(x = dist_edge_x1, y = log_TSLV_x1, z = log_rss))+
  stat_contour(geom = "polygon", aes(fill = ..level..), bins = 5)+
  geom_tile(aes(fill = log_rss))+
  scale_fill_distiller(palette = "Spectral", direction = 1)+
  labs(fill = "log_RSS")+
  xlab("Distance to the edge (m)")+
  ylab("TSLV (day)")+
  #ggtitle("(b) method3: log-RSS vs Mean dist_edge and TSLV")+
  theme_classic()

plot2_m1_30
plot2_m2_30
plot2_m3_30
```

## 6 month burn in period
```{r RSS dist 3 month}
# creating vectors
tslv_range_60 <- seq(from = 0, to = 60, length.out = 100)

# expand grid - 60 days
exp_grid_tslv_60_dist <- expand.grid(dist_range, tslv_range_60)
colnames(exp_grid_tslv_60_dist) <- c("dist_edge", "log_TSLV")
exp_grid_tslv_60_dist

# include all the necessary data.frame 
exp_grid_tslv_60_dist$sl_ <- 1000
exp_grid_tslv_60_dist$log_sl_ <- log(1000)
exp_grid_tslv_60_dist$cos_ta_ <- 1

exp_grid_tslv_60_dist

# data.frame for s2 
s2_60days <- data.frame(
    dist_edge = 952,
    log_TSLV = log(30),
    sl_ = 1000,
    log_sl_ = log(1000),
    cos_ta_ = 1
)

# calculate log-RSS with large-sample confidence intervals 

## method 1
lr_m1_60 <- amt::log_rss(tslv.model1.2, exp_grid_tslv_60_dist, s2_60days)
lr_m1_60 <- lr_m1_60$df

## method 2
lr_m2_60 <- amt::log_rss(tslv.model2.2, exp_grid_tslv_60_dist, s2_60days)
lr_m2_60 <- lr_m2_60$df
lr_m2_60

## method 3
lr_m3_60 <- amt::log_rss(tslv.model3.2, exp_grid_tslv_60_dist, s2_60days)
lr_m3_60 <- lr_m3_60$df
lr_m3_60
```

plot - 60 days
```{r linear RSS 60}
plot2_m1_60 <- ggplot(lr_m1_60, aes(x = dist_edge_x1, y = log_TSLV_x1, z = log_rss))+
  stat_contour(geom = "polygon", aes(fill = ..level..), bins = 5)+
  geom_tile(aes(fill = log_rss))+
  scale_fill_distiller(palette = "Spectral", direction = 1)+
  labs(fill = "log_RSS")+
  xlab("Distance to the edge (m)")+
  ylab("TSLV (day)")+
  #ggtitle("(b) method 1: log-RSS vs Mean dist_edge and TSLV")+
  theme_classic()

plot2_m2_60 <- ggplot(lr_m2_60, aes(x = dist_edge_x1, y = log_TSLV_x1, z = log_rss))+
  stat_contour(geom = "polygon", aes(fill = ..level..), bins = 5)+
  geom_tile(aes(fill = log_rss))+
  scale_fill_distiller(palette = "Spectral", direction = 1)+
  labs(fill = "log_RSS")+
  xlab("Distance to the edge (m)")+
  ylab("TSLV (day)")+
  #ggtitle("(b) method 2.1: log-RSS vs Mean dist_edge and TSLV")+
  theme_classic()

plot2_m3_60 <- ggplot(lr_m3_60, aes(x = dist_edge_x1, y = log_TSLV_x1, z = log_rss))+
  stat_contour(geom = "polygon", aes(fill = ..level..), bins = 5)+
  geom_tile(aes(fill = log_rss))+
  scale_fill_distiller(palette = "Spectral", direction = 1)+
  labs(fill = "log_RSS")+
  xlab("Distance to the edge (m)")+
  ylab("TSLV (day)")+
  #ggtitle("(b) method3: log-RSS vs Mean dist_edge and TSLV")+
  theme_classic()

plot2_m1_60
plot2_m2_60
plot2_m3_60
```

combine the plots 
```{r combine the plots}
# 1 month 
grid_30days <-
  gridExtra::grid.arrange(plot1_m1_30,
                          plot1_m2_30,
                          plot1_m3_30,
                          plot2_m1_30,
                          plot2_m2_30,
                          plot2_m3_30,
                          nrow = 2,
                          ncol = 3)
grid_30days

# 2 months
grid_60days <-
  gridExtra::grid.arrange(plot1_m1_60,
                          plot1_m2_60,
                          plot1_m3_60,
                          plot2_m1_60,
                          plot2_m2_60,
                          plot2_m3_60,
                          nrow = 2,
                          ncol = 3)
grid_60days
```

save the plot
```{r save the plot}
ggsave("method_burnin_30days.png", grid_30days, width = 15, height = 8, dpi = 700, bg = NA)
ggsave("method_burnin-60days.png", grid_60days, width = 15, height = 8, dpi = 700, bg = NA)
```

# Document Footer 
```{r session info}
sessionInfo()
```